#!/usr/bin/env node
/**
 * Configuration updater for Linera Casino
 * Usage: node update-constants.mjs <APP_ID> <CHAIN_ID> <MODE>
 * 
 * MODE: "devnet" or "testnet"
 * 
 * This script:
 * 1. Updates .env.local with VITE_NETWORK_MODE
 * 2. Updates src/constants.ts with APP_ID and BANK_CHAIN_ID
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { join } from 'path';

const [, , appId, chainId, mode = 'testnet'] = process.argv;

if (!appId || !chainId) {
    console.error('Usage: node update-constants.mjs <APP_ID> <CHAIN_ID> [MODE]');
    console.error('MODE: devnet | testnet (default: testnet)');
    process.exit(1);
}

// Default to /app for Docker, but support running from project root
const baseDir = process.cwd().includes('/app') ? '/app' : process.cwd();
const envPath = join(baseDir, '.env.local');
const constantsPath = join(baseDir, 'src', 'constants.ts');

console.log(`Mode: ${mode.toUpperCase()}`);
console.log(`APP_ID: ${appId}`);
console.log(`BANK_CHAIN_ID: ${chainId}`);

// ========================================
// Update .env.local (for network mode)
// ========================================
console.log(`\nUpdating ${envPath}...`);

// Read existing .env.local to preserve other vars
let existingVars = {};
if (existsSync(envPath)) {
    const content = readFileSync(envPath, 'utf8');
    for (const line of content.split('\n')) {
        const trimmed = line.trim();
        if (trimmed && !trimmed.startsWith('#')) {
            const eqIndex = trimmed.indexOf('=');
            if (eqIndex > 0) {
                const key = trimmed.substring(0, eqIndex);
                const value = trimmed.substring(eqIndex + 1);
                existingVars[key] = value;
            }
        }
    }
}

// Build .env.local content
let envContent = `# Linera Casino Environment
# Auto-generated by update-constants.mjs

# Network Mode (devnet or testnet)
VITE_NETWORK_MODE=${mode}

# Dynamic Wallet ID
VITE_DYNAMIC_ENVIRONMENT_ID=658341ca-ee81-4763-8767-e266c3cff17c
`;

writeFileSync(envPath, envContent, 'utf8');
console.log('✅ .env.local updated!');

// ========================================
// Update constants.ts (for APP_ID and BANK_CHAIN_ID)
// ========================================
console.log(`\nUpdating ${constantsPath}...`);

let constantsContent = readFileSync(constantsPath, 'utf8');

// Replace APP_ID
constantsContent = constantsContent.replace(
    /export const APP_ID = ".*";/,
    `export const APP_ID = "${appId}";`
);

// Replace BANK_CHAIN_ID
constantsContent = constantsContent.replace(
    /export const BANK_CHAIN_ID = ".*";/,
    `export const BANK_CHAIN_ID = "${chainId}";`
);

writeFileSync(constantsPath, constantsContent, 'utf8');
console.log('✅ constants.ts updated!');

console.log('\n✅ All configuration updated successfully!');
